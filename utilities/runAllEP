#!/bin/bash

Color_OFF="[0m"
Color1="[31m"
Color7="[37m"

if [[ "$#" -ne 5 ]] && [[ "$#" -ne 6 ]]; then
    echo "Usage: run min max hostfile testtype sizesfile [extension]"
    exit 1
fi

if [[ "$#" -eq 6 ]]; then
    EXT=$6
else
    EXT=""
fi

echo "$Color7"
echo "RUNNING TEST SUIT"
echo ""
echo "Updating /smmProject in the Cluster"
echo "$ColorOFF"
updateSmmProject


MAXRUN=6
MIN=$1
MAX=$2
HOSTFILE=$3
TESTTYPE=$4
x=$MIN
r=1

STARTTIME=`date +%s`
while read j; do
    while [ $x -le $MAX ]; do
        while [ $r -le $MAXRUN ]; do
            echo ""
            echo ""
            echo "$Color7"
            echo "Current Test Parameters"
            echo "World size              : $j"
            echo "Number of processes     : $x"
            echo "Extension               : $EXT"
            echo "Test type               : $TESTTYPE"
            echo "Hostfile                : $HOSTFILE"
            echo "Minimum number of cores : $HOSTFILE"
            echo "EXPERIMENT NUMBER       : $r"
            echo "EXPERIMENTS MAXIMUM     : $MAXRUN"
            echo "$ColorOFF"
            echo ""
            if ! testRunner $TESTTYPE $HOSTFILE $j $x $MIN $EXT ; then
                echo "SKIPPED"
                break
            fi
            echo $?
            r=$(($r+1))
        done
        r=1
        x=$(($x+1))
    done
    x=$2
done < $5
ENDTIME=`date +%s`
TOTALTIME=$((($ENDTIME-$STARTTIME)/60))

receiver="konstan2@pdx.edu"
subj="Autogenerated email: Script complete"
message="Script $1 $2 $3 $4 completed Total runtime: $TOTALTIME min."
ssh linuxlab "mail -s \"$subj\" $receiver <<< \"$message\""
