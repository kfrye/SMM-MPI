#!/bin/bash

myhelp() {
    echo "All options except [-ext] are requred: "
    echo "    -minprocs      Minimum number of processes"
    echo "    -maxprocs      Maximum Number of Processes"
    echo "    -hfile         HostFile Absolute path"
    echo "    -type          Testype"
    echo "    -sizefile      WorldSize file"
    echo "    -enum          number of experiments"
    echo ""
    echo "    -ext           <extension - optional>"
    echo "Example: runAllEP -minprocs 4 -maxprocs 64 -hfile /smmProject/hosts4 -type bt -sizefile /smmProject/S -enum 6 -ext mpi_io_full"
    exit 1
}

if [[ "$#" -le 1 ]]; then
    myhelp
fi
SCRIPT=$@
while [[ $# > 1 ]]
do
key="$1"

case $key in
    --minprocs)
    MINPROCS="$2"
    shift # past argument
    ;;
    --maxprocs)
    MAXPROCS="$2"
    shift # past argument
    ;;
    --hfile)
    HFILE="$2"
    shift # past argument
    ;;
    --type)
    TTYPE="$2"
    shift # past argument
    ;;
    --sizefile)
    WSIZE="$2"
    shift # past argument
    ;;
    --enum)
    EXPERIMENTS="$2"
    shift # past argument
    ;;
    --ext)
    EXTENSION="$2"
    shift # past argument
    ;;
    -h|--help)
    echo "HELP"
    myhelp
    ;;
    --default)
    DEFAULT=YES
    ;;
    *)
    echo "Unknown argument encountered : $key . Exit"
    myhelp
            # unknown option
    ;;
esac
shift # past argument or value
done

Color_OFF="[0m"
Color1="[31m"
Color7="[37m"


#echo "$Color7"
#echo "RUNNING TEST SUIT"
#echo ""
#echo "Updating /smmProject in the Cluster"
#echo "$ColorOFF"
#updateSmmProject

if [ -z "$EXTENSION" ]; then
    EXT=""
else
    EXT=$EXTENSION
fi

MAXRUN=$EXPERIMENTS
MIN=$MINPROCS
MAX=$MAXPROCS
HOSTFILE=$HFILE
TESTTYPE=$TTYPE
SIZES=$WSIZE
x=$MIN
r=1

#echo "$EXT     "
#echo "$MAXRUN  "
#echo "$MIN     "
#echo "$MAX     "
#echo "$HOSTFILE"
#echo "$TESTTYPE"
#echo "$x       "
#echo "$r       "
#exit 0
STARTTIME=`date +%s`
while read j; do
    while [ $x -le $MAX ]; do
        while [ $r -le $MAXRUN ]; do
            echo ""
            echo ""
            echo "$Color7"
            echo "Current Test Parameters"
            echo "World size              : $j"
            echo "Number of processes     : $x"
            echo "Extension               : $EXT"
            echo "Test type               : $TESTTYPE"
            echo "Hostfile                : $HOSTFILE"
            echo "Minimum number of cores : $HOSTFILE"
            echo "EXPERIMENT NUMBER       : $r"
            echo "EXPERIMENTS MAXIMUM     : $MAXRUN"
            curTime=`date`
            echo "Time Started            : $curTime"
            echo "$ColorOFF"
            echo ""
            if ! testRunner $TESTTYPE $HOSTFILE $j $x $MIN $EXT ; then
                echo "SKIPPED"
                break
            fi
            curTime=`date`
            echo "$Color7"
            echo "Time Ended              : $curTime"
            echo "**********************************"
            echo "$ColorOFF"
            echo ""
            r=$(($r+1))
        done
        r=1
        x=$(($x+1))
    done
    x=$MIN
done < $SIZES
ENDTIME=`date +%s`
TOTALTIME=$((($ENDTIME-$STARTTIME)/60))

receiver="konstan2@pdx.edu"
subj="Autogenerated email: Script complete"
message="Script $SCRIPT completed Total runtime: $TOTALTIME min."
ssh linuxlab "mail -s \"$subj\" $receiver <<< \"$message\""
